---
name: 🐧 Ubuntu package
on:
  push:
    branches:
      - master
      - release-**
      - deb
  pull_request:
  release:
    types: ['published']


jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          remove-android: 'true'
          remove-haskell: 'true'
          remove-dotnet: 'true'
          root-reserve-mb: 4096

      - name: 🐣 Checkout
        uses: actions/checkout@v3

      - name: 🔨 Prepare build env
        run: |
          sudo apt-get update
          sudo apt-get install -y devscripts equivs
          sudo mk-build-deps --install --tool='apt-get -o Debug::pkgProblemResolver=yes --no-install-recommends --yes' debian/control

      - name: 🌋 Build
        env:
          NUGET_USERNAME: opengisch
          NUGET_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          dpkg-buildpackage

      - name: 📑 Upload dep build logs
        uses: actions/upload-artifact@v3
        if: failure()
        with:
          name: build-logs
          path: |
            ${{ github.workspace }}/**/*.log

      - uses: actions/upload-artifact@v3
        with:
          name: debian-package
          path: ${{ github.workspace }}/../*.deb
